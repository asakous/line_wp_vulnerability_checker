<?php
	
	
	$channelAccessToken = '';	// line nofify token 需自行申請 https://notify-bot.line.me/zh_TW/
	$lists=array('/var/www/xxxx/wp-content/plugins/*');//請改成你的實際plugin目錄，允許多個目錄。
	
	foreach($lists as $list) {
		$dir=array();
		$directories = glob($list , GLOB_ONLYDIR);
		
		foreach ($directories as $directorie) {
			
			$dir[]= basename($directorie);
			
		}
		
		
		$json=json_decode(file_get_contents('vulnerabilities.json'));
		
		$email=0;
		$content= $list."\n";
		foreach($json as $plugin) {
			
			// print_r($v->software[0])."";
			if ($plugin->software[0]->type=='plugin') {
				if (in_array($plugin->software[0]->slug, $dir)) {
					$date1  = new DateTime();
					$date2 = new DateTime($plugin->updated);
					$diff = $date2->diff($date1);
					$hours = $diff->h;
					$hours = $hours + ($diff->days*24);			
					if ($hours <= 24) { //每天作1次，24小時內的資料才報告
						$content.=  "slug\t".$plugin->software[0]->slug."\n";
						$content.=   "title\t".$plugin->title."\n";
						$content.=   "name\t".$plugin->software[0]->name."\n";
						$content.=   "patched\t".$plugin->software[0]->patched."\n";
						$content.=  "hours\t".$hours."\n";
						$content.=  "score\t".$plugin->cvss->score."\n";
						$content.=  "rating\t".$plugin->cvss->rating."";
						$content.=  "updated\t".$plugin->updated."\n";
						$email=1;
						if ($email) {							
							sendNofity($content,$channelAccessToken);
						}
					}
				}
			}
			
			
			
			
		}
		
		
	}
	
	
	
	function sendNofity($content,$channelAccessToken) {
		
		
		
		$message = array(
		'message' => $content
		);
		
		
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, 'https://notify-api.line.me/api/notify');
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'POST');
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, false);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_POSTFIELDS,$message);
        curl_setopt($ch, CURLOPT_HTTPHEADER, [
		'Content-Type: multipart/form-data',
		'Authorization: Bearer ' . $channelAccessToken
        ]);
        $result = curl_exec($ch);
		
        curl_close($ch);
		
		
		
		
	}
